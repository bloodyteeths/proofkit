{% extends "modern_base.html" %}

{% block title %}Verify Results - ProofKit{% endblock %}

{% block content %}
<div class="verify-container">
<section class="verify-section">
    <h2>Verification Results</h2>
    <p>Independent verification of evidence bundle: <code>{{ bundle_id }}</code></p>
    
    <!-- Verification Status Banner -->
    <div class="result-banner {{ 'pass' if verification.valid else 'fail' }}">
        {% if verification.valid %}
            ‚úì VERIFIED - Evidence Bundle is Valid and Untampered
        {% else %}
            ‚úó VERIFICATION FAILED - Evidence Bundle has Issues
        {% endif %}
    </div>
    
    <!-- Verification Details -->
    <div style="margin-top: 2rem;">
        <h3>Verification Checks</h3>
        <table>
            <thead>
                <tr>
                    <th>Check</th>
                    <th>Status</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Bundle Integrity</td>
                    <td>{{ "‚úì Pass" if verification.integrity_valid else "‚úó Fail" }}</td>
                    <td>{{ verification.integrity_message or "All file hashes match manifest" }}</td>
                </tr>
                <tr>
                    <td>Decision Reproducibility</td>
                    <td>{{ "‚úì Pass" if verification.decision_valid else "‚úó Fail" }}</td>
                    <td>{{ verification.decision_message or "Re-computed decision matches original" }}</td>
                </tr>
                <tr>
                    <td>Manifest Validity</td>
                    <td>{{ "‚úì Pass" if verification.manifest_valid else "‚úó Fail" }}</td>
                    <td>{{ verification.manifest_message or "Manifest format and content valid" }}</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <!-- Original Results (if verification passed) -->
    {% if verification.valid and verification.decision %}
    <div style="margin-top: 2rem;">
        <h3>Original Validation Results</h3>
        
        <!-- PASS/FAIL Banner -->
        <div class="result-banner {{ 'pass' if verification.decision.pass else 'fail' }}" style="font-size: 1.2em;">
            {% if verification.decision.pass %}
                ‚úì PASS - Temperature Requirements Met
            {% else %}
                ‚úó FAIL - Temperature Requirements Not Met
            {% endif %}
        </div>
        
        <!-- Metrics Table -->
        {% if verification.decision.metrics %}
        <div class="metrics-table">
            <h4>Validation Metrics</h4>
            <table>
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Value</th>
                        <th>Requirement</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Target Temperature</td>
                        <td>{{ "%.1f¬∞C" | format(verification.decision.metrics.target_temp_C) }}</td>
                        <td>{{ "%.1f¬∞C" | format(verification.decision.metrics.target_temp_C) }}</td>
                        <td>‚úì</td>
                    </tr>
                    <tr>
                        <td>Hold Time Required</td>
                        <td>{{ verification.decision.metrics.required_hold_time_s }}s</td>
                        <td>{{ verification.decision.metrics.required_hold_time_s }}s</td>
                        <td>{{ "‚úì" if verification.decision.metrics.actual_hold_time_s >= verification.decision.metrics.required_hold_time_s else "‚úó" }}</td>
                    </tr>
                    <tr>
                        <td>Hold Time Achieved</td>
                        <td>{{ verification.decision.metrics.actual_hold_time_s }}s</td>
                        <td>‚â• {{ verification.decision.metrics.required_hold_time_s }}s</td>
                        <td>{{ "‚úì" if verification.decision.metrics.actual_hold_time_s >= verification.decision.metrics.required_hold_time_s else "‚úó" }}</td>
                    </tr>
                    {% if verification.decision.metrics.max_temp_C %}
                    <tr>
                        <td>Maximum Temperature</td>
                        <td>{{ "%.1f¬∞C" | format(verification.decision.metrics.max_temp_C) }}</td>
                        <td>-</td>
                        <td>‚Ñπ</td>
                    </tr>
                    {% endif %}
                    {% if verification.decision.metrics.time_to_threshold_s %}
                    <tr>
                        <td>Time to Threshold</td>
                        <td>{{ verification.decision.metrics.time_to_threshold_s }}s</td>
                        <td>-</td>
                        <td>‚Ñπ</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        {% endif %}
        
        <!-- Reasons -->
        {% if verification.decision.reasons %}
        <div style="margin-top: 1rem;">
            <h4>{% if verification.decision.pass %}Validation Passed{% else %}Validation Failed{% endif %}</h4>
            <ul>
                {% for reason in verification.decision.reasons %}
                    <li>{{ reason }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        
        <!-- Warnings -->
        {% if verification.decision.warnings %}
        <div style="margin-top: 1rem;">
            <h4>Warnings</h4>
            <ul style="color: var(--warning-color);">
                {% for warning in verification.decision.warnings %}
                    <li>{{ warning }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Verification Errors (if verification failed) -->
    {% if not verification.valid %}
    <div style="margin-top: 2rem;">
        <h3>Verification Issues</h3>
        {% if verification.errors %}
        <ul class="error-message">
            {% for error in verification.errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Free Tier Upgrade Prompt -->
    {% if user and user.plan == 'free' %}
    <div class="free-tier-upgrade-notice" style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, #f7fafc, #edf2f7); border-left: 4px solid #667eea; border-radius: 0.5rem;">
        <div style="display: flex; align-items: center; margin-bottom: 1rem;">
            <div style="font-size: 1.5rem; margin-right: 0.75rem;">üöÄ</div>
            <h4 style="margin: 0; color: #1a202c;">Remove the Trial Watermark</h4>
        </div>
        <p style="margin-bottom: 1.5rem; color: #4a5568; line-height: 1.6;">
            This certificate includes a trial watermark. Upgrade to any paid plan to generate production-ready certificates without watermarks for your compliance documentation.
        </p>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
            <a href="/pricing" class="upgrade-button" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; text-decoration: none; font-weight: 600; transition: all 0.3s ease;">
                View Upgrade Options
            </a>
            <div style="font-size: 0.875rem; color: #718096;">
                Starting at <strong>‚Ç¨14/month</strong> ‚Ä¢ No watermarks ‚Ä¢ Professional PDFs
            </div>
        </div>
    </div>
    {% elif not user %}
    <div class="anonymous-user-notice" style="margin-top: 2rem; padding: 1.5rem; background: #f8f9ff; border: 1px solid #e2e8f0; border-radius: 0.5rem;">
        <div style="display: flex; align-items: center; margin-bottom: 1rem;">
            <div style="font-size: 1.5rem; margin-right: 0.75rem;">üîê</div>
            <h4 style="margin: 0; color: #1a202c;">Secure Your Certificates</h4>
        </div>
        <p style="margin-bottom: 1.5rem; color: #4a5568; line-height: 1.6;">
            Create a free ProofKit account to generate your own certificates, track your validation history, and access advanced features.
        </p>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
            <a href="/auth/login" class="signup-button" style="background: #667eea; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; text-decoration: none; font-weight: 600;">
                Sign Up Free
            </a>
            <div style="font-size: 0.875rem; color: #718096;">
                Get <strong>2 free certificates</strong> ‚Ä¢ No credit card required
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Download Original Files -->
    <div style="margin-top: 2rem;">
        <h3>Download Original Files</h3>
        <p>You can download the original files from this evidence bundle:</p>
        
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <a href="/download/{{ bundle_id }}/pdf" class="primary" role="button">
                üìÑ Original Proof PDF
            </a>
            <a href="/download/{{ bundle_id }}/zip" class="secondary" role="button">
                üì¶ Complete Evidence Bundle
            </a>
        </div>
    </div>
    
    <!-- Technical Details -->
    <details style="margin-top: 2rem;">
        <summary><strong>Technical Verification Details</strong></summary>
        <div style="margin-top: 1rem;">
            <h4>Bundle Information</h4>
            <table>
                <tbody>
                    <tr>
                        <td><strong>Bundle ID:</strong></td>
                        <td><code>{{ bundle_id }}</code></td>
                    </tr>
                    <tr>
                        <td><strong>Root Hash:</strong></td>
                        <td><code>{{ verification.root_hash or "N/A" }}</code></td>
                    </tr>
                    <tr>
                        <td><strong>Verification Time:</strong></td>
                        <td>{{ verification.timestamp or "N/A" }}</td>
                    </tr>
                    <tr>
                        <td><strong>ProofKit Version:</strong></td>
                        <td>{{ verification.version or "0.1.0" }}</td>
                    </tr>
                </tbody>
            </table>
            
            {% if verification.file_hashes %}
            <h4>File Integrity</h4>
            <table>
                <thead>
                    <tr>
                        <th>File</th>
                        <th>Hash Status</th>
                        <th>SHA-256</th>
                    </tr>
                </thead>
                <tbody>
                    {% for file_info in verification.file_hashes %}
                    <tr>
                        <td><code>{{ file_info.filename }}</code></td>
                        <td>{{ "‚úì Valid" if file_info.valid else "‚úó Invalid" }}</td>
                        <td><code style="font-size: 0.8em;">{{ file_info.hash[:16] }}...</code></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
        </div>
    </details>
    
    <!-- Actions -->
    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--muted-border-color);">
        <a href="/" class="outline" role="button">
            üè† Back to Upload
        </a>
    </div>
</section>
</div>

<style>
.verify-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

.verify-section {
    background: white;
    border-radius: 0.75rem;
    padding: 2rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.verify-section h2 {
    color: var(--primary-color, #667eea);
    margin-bottom: 1rem;
    font-size: 2rem;
}

.verify-section h3 {
    color: var(--primary-color, #667eea);
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-size: 1.5rem;
}

.verify-section h4 {
    color: #374151;
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    font-size: 1.125rem;
}

.verify-section p {
    color: #6b7280;
    line-height: 1.6;
    margin-bottom: 1rem;
}

.verify-section code {
    background: #f3f4f6;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-family: monospace;
    font-size: 0.9rem;
    color: #111827;
}

/* Result Banner Styling */
.result-banner {
    padding: 1.5rem;
    border-radius: 0.5rem;
    margin: 1.5rem 0;
    font-size: 1.125rem;
    font-weight: 600;
    text-align: center;
    animation: fadeIn 0.5s ease;
}

.result-banner.pass {
    background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
    color: #166534;
    border: 2px solid #86efac;
}

.result-banner.fail {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    color: #991b1b;
    border: 2px solid #fca5a5;
}

/* Table Styling */
.verify-section table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
    background: white;
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.verify-section thead {
    background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
}

.verify-section th {
    padding: 0.75rem 1rem;
    text-align: left;
    font-weight: 600;
    color: #374151;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 2px solid #e5e7eb;
}

.verify-section td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #f3f4f6;
    color: #4b5563;
}

.verify-section tbody tr:hover {
    background: #f9fafb;
    transition: background 0.2s ease;
}

.verify-section tbody tr:last-child td {
    border-bottom: none;
}

/* Metrics Table */
.metrics-table {
    margin-top: 1.5rem;
    padding: 1.5rem;
    background: #f9fafb;
    border-radius: 0.5rem;
}

.metrics-table h4 {
    margin-top: 0;
    color: var(--primary-color, #667eea);
}

/* Error Messages */
.error-message {
    background: #fef2f2;
    border-left: 4px solid #ef4444;
    padding: 1rem;
    border-radius: 0.25rem;
    margin: 1rem 0;
}

.error-message li {
    color: #991b1b;
    margin: 0.5rem 0;
}

/* Warning Messages */
.verify-section ul {
    list-style-type: none;
    padding-left: 0;
}

.verify-section ul li {
    padding: 0.5rem 0;
    padding-left: 1.5rem;
    position: relative;
}

.verify-section ul li:before {
    content: "‚Üí";
    position: absolute;
    left: 0;
    color: var(--primary-color, #667eea);
    font-weight: bold;
}

/* Buttons */
.verify-section a[role="button"], 
.verify-section .primary, 
.verify-section .secondary,
.verify-section .outline {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
    margin: 0.5rem;
    cursor: pointer;
}

.verify-section .primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
}

.verify-section .primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
}

.verify-section .secondary {
    background: white;
    color: var(--primary-color, #667eea);
    border: 2px solid var(--primary-color, #667eea);
}

.verify-section .secondary:hover {
    background: var(--primary-color, #667eea);
    color: white;
}

.verify-section .outline {
    background: transparent;
    color: #6b7280;
    border: 2px solid #e5e7eb;
}

.verify-section .outline:hover {
    border-color: var(--primary-color, #667eea);
    color: var(--primary-color, #667eea);
}

/* Details/Summary Styling */
.verify-section details {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-top: 2rem;
}

.verify-section summary {
    cursor: pointer;
    font-weight: 600;
    color: #374151;
    padding: 0.5rem;
    user-select: none;
    transition: color 0.2s ease;
}

.verify-section summary:hover {
    color: var(--primary-color, #667eea);
}

.verify-section details[open] summary {
    margin-bottom: 1rem;
    color: var(--primary-color, #667eea);
}

/* Upgrade Notice Styling */
.free-tier-upgrade-notice,
.anonymous-user-notice {
    animation: slideIn 0.5s ease;
}

.upgrade-button,
.signup-button {
    display: inline-block;
    transition: all 0.3s ease;
}

.upgrade-button:hover,
.signup-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
}

/* Animations */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Responsive Design */
@media (max-width: 768px) {
    .verify-container {
        padding: 1rem;
    }
    
    .verify-section {
        padding: 1.5rem;
    }
    
    .verify-section h2 {
        font-size: 1.5rem;
    }
    
    .verify-section h3 {
        font-size: 1.25rem;
    }
    
    .verify-section table {
        font-size: 0.875rem;
    }
    
    .verify-section th,
    .verify-section td {
        padding: 0.5rem;
    }
    
    .verify-section a[role="button"],
    .verify-section .primary,
    .verify-section .secondary,
    .verify-section .outline {
        display: block;
        width: 100%;
        text-align: center;
        margin: 0.5rem 0;
    }
}

/* Status Icons */
.verify-section td:contains("‚úì"),
.verify-section td:contains("‚úó") {
    font-weight: 600;
}

.verify-section td:contains("‚úì") {
    color: #16a34a;
}

.verify-section td:contains("‚úó") {
    color: #dc2626;
}

/* Code blocks in tables */
.verify-section table code {
    background: #f9fafb;
    padding: 0.125rem 0.25rem;
    font-size: 0.8rem;
}

/* Divider */
.verify-section > div[style*="border-top"] {
    margin-top: 3rem !important;
    padding-top: 2rem !important;
    border-top: 2px solid #e5e7eb !important;
}
</style>
{% endblock %}