{% extends "base.html" %}

{% block content %}
<div class="container" style="max-width: 1400px; margin: 2rem auto; padding: 0 1rem;">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem;">
        <div>
            <h1 style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; color: #1a1a1a;">Campaign Analysis</h1>
            <p style="color: #666; margin-bottom: 0;">Validation accuracy metrics and disagreement analysis by industry</p>
        </div>
        
        <!-- Strict Mode Toggle -->
        <div style="display: flex; align-items: center; gap: 1rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: #374151;">
                <input type="checkbox" id="strictMode" onchange="toggleStrictMode()" 
                       {% if request.args.get('strict') == 'true' %}checked{% endif %}
                       style="width: 1rem; height: 1rem;">
                Strict Mode
            </label>
            <div id="strictModeInfo" style="background: #fef3c7; color: #92400e; padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 600; display: none;">
                Any off-tolerance → RED
            </div>
        </div>
    </div>
    
    <!-- Overview Cards -->
    <div style="display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); margin-bottom: 3rem;">
        {% set total_tests = campaign_data.values() | sum(attribute='total_tests') %}
        {% set total_accuracy = [] %}
        {% for industry, data in campaign_data.items() %}
            {% set cm = data.confusion_matrix %}
            {% set accuracy = ((cm.true_positive + cm.true_negative) / data.total_tests * 100) %}
            {% set _ = total_accuracy.append(accuracy) %}
        {% endfor %}
        
        <div class="card">
            <div style="font-size: 2.5rem; font-weight: 700; color: #3b82f6; margin-bottom: 0.5rem;">{{ total_tests }}</div>
            <div style="font-weight: 600; color: #374151;">Total Test Cases</div>
            <div style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem;">Across all industries</div>
        </div>
        
        <div class="card">
            <div style="font-size: 2.5rem; font-weight: 700; color: #10b981; margin-bottom: 0.5rem;">{{ "%.1f" | format(total_accuracy | sum / total_accuracy | length) }}%</div>
            <div style="font-weight: 600; color: #374151;">Average Accuracy</div>
            <div style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem;">Mean across industries</div>
        </div>
        
        <div class="card">
            <div style="font-size: 2.5rem; font-weight: 700; color: #f59e0b; margin-bottom: 0.5rem;">{{ campaign_data | length }}</div>
            <div style="font-weight: 600; color: #374151;">Industries Tested</div>
            <div style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem;">Validation coverage</div>
        </div>
    </div>
    
    <!-- Industry Analysis -->
    {% for industry, data in campaign_data.items() %}
    {% set cm = data.confusion_matrix %}
    {% set accuracy = ((cm.true_positive + cm.true_negative) / data.total_tests * 100) %}
    {% set precision = (cm.true_positive / (cm.true_positive + cm.false_positive) * 100) if (cm.true_positive + cm.false_positive) > 0 else 0 %}
    {% set recall = (cm.true_positive / (cm.true_positive + cm.false_negative) * 100) if (cm.true_positive + cm.false_negative) > 0 else 0 %}
    {% set strict_mode = request.args.get('strict') == 'true' %}
    {% set is_off_tolerance = (cm.false_positive > 0 or cm.false_negative > 0) %}
    {% set strict_fail = strict_mode and is_off_tolerance %}
    
    <div class="card" style="margin-bottom: 2.5rem;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem;">
            <div>
                <h2 style="font-size: 1.75rem; font-weight: 600; color: #1a1a1a; text-transform: capitalize;">{{ industry }} Coating</h2>
                {% if strict_mode %}
                <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">
                    Strict Mode: Any disagreement marked as failure
                </div>
                {% endif %}
            </div>
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                {% if strict_fail %}
                <!-- Strict Mode Failure Badge -->
                <div style="background: #dc2626; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                    🚨 STRICT FAIL
                </div>
                {% endif %}
                <div style="background: {% if strict_fail %}#fef2f2{% elif accuracy >= 95 %}#d1fae5{% elif accuracy >= 90 %}#fef3c7{% else %}#fef2f2{% endif %}; color: {% if strict_fail %}#dc2626{% elif accuracy >= 95 %}#065f46{% elif accuracy >= 90 %}#92400e{% else %}#dc2626{% endif %}; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600;">
                    {{ "%.1f" | format(accuracy) }}% Accuracy
                </div>
            </div>
        </div>
        
        <div style="display: grid; gap: 2rem; grid-template-columns: 1fr 1fr;">
            <!-- Confusion Matrix -->
            <div>
                <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: #374151;">
                    Confusion Matrix
                    {% if strict_mode %}
                    <span style="font-size: 0.875rem; font-weight: 400; color: #dc2626; margin-left: 0.5rem;">(Strict Mode)</span>
                    {% endif %}
                </h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; max-width: 400px;">
                    <!-- True Positive -->
                    <div style="background: #d1fae5; padding: 1rem; border-radius: 0.5rem; text-align: center; border: 2px solid #10b981;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #065f46;">{{ cm.true_positive }}</div>
                        <div style="font-size: 0.875rem; font-weight: 600; color: #065f46;">True Positive</div>
                        <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">Correct PASS</div>
                    </div>
                    <!-- False Positive -->
                    <div style="background: {% if strict_mode and cm.false_positive > 0 %}#991b1b{% else %}#fef2f2{% endif %}; padding: 1rem; border-radius: 0.5rem; text-align: center; border: {% if strict_mode and cm.false_positive > 0 %}3px solid #dc2626; box-shadow: 0 0 0 2px #fca5a5{% else %}2px solid #ef4444{% endif %};">
                        <div style="font-size: 1.5rem; font-weight: 700; color: {% if strict_mode and cm.false_positive > 0 %}white{% else %}#dc2626{% endif %};">{{ cm.false_positive }}</div>
                        <div style="font-size: 0.875rem; font-weight: 600; color: {% if strict_mode and cm.false_positive > 0 %}white{% else %}#dc2626{% endif %};">False Positive</div>
                        <div style="font-size: 0.75rem; color: {% if strict_mode and cm.false_positive > 0 %}#fca5a5{% else %}#6b7280{% endif %}; margin-top: 0.25rem;">Wrong PASS</div>
                        {% if strict_mode and cm.false_positive > 0 %}
                        <div style="font-size: 0.75rem; color: #fef2f2; margin-top: 0.5rem; font-weight: 600;">🚨 STRICT FAIL</div>
                        {% endif %}
                    </div>
                    <!-- False Negative -->
                    <div style="background: {% if strict_mode and cm.false_negative > 0 %}#991b1b{% else %}#fef2f2{% endif %}; padding: 1rem; border-radius: 0.5rem; text-align: center; border: {% if strict_mode and cm.false_negative > 0 %}3px solid #dc2626; box-shadow: 0 0 0 2px #fca5a5{% else %}2px solid #ef4444{% endif %};">
                        <div style="font-size: 1.5rem; font-weight: 700; color: {% if strict_mode and cm.false_negative > 0 %}white{% else %}#dc2626{% endif %};">{{ cm.false_negative }}</div>
                        <div style="font-size: 0.875rem; font-weight: 600; color: {% if strict_mode and cm.false_negative > 0 %}white{% else %}#dc2626{% endif %};">False Negative</div>
                        <div style="font-size: 0.75rem; color: {% if strict_mode and cm.false_negative > 0 %}#fca5a5{% else %}#6b7280{% endif %}; margin-top: 0.25rem;">Wrong FAIL</div>
                        {% if strict_mode and cm.false_negative > 0 %}
                        <div style="font-size: 0.75rem; color: #fef2f2; margin-top: 0.5rem; font-weight: 600;">🚨 STRICT FAIL</div>
                        {% endif %}
                    </div>
                    <!-- True Negative -->
                    <div style="background: #d1fae5; padding: 1rem; border-radius: 0.5rem; text-align: center; border: 2px solid #10b981;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #065f46;">{{ cm.true_negative }}</div>
                        <div style="font-size: 0.875rem; font-weight: 600; color: #065f46;">True Negative</div>
                        <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">Correct FAIL</div>
                    </div>
                </div>
            </div>
            
            <!-- Performance Metrics -->
            <div>
                <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: #374151;">Performance Metrics</h3>
                <div style="display: grid; gap: 1rem;">
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; color: #374151;">Accuracy</div>
                            <div style="color: #6b7280; font-size: 0.875rem;">Overall correctness</div>
                        </div>
                        <div style="font-size: 1.25rem; font-weight: 700; color: #3b82f6;">{{ "%.1f" | format(accuracy) }}%</div>
                    </div>
                    
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; color: #374151;">Precision</div>
                            <div style="color: #6b7280; font-size: 0.875rem;">PASS prediction accuracy</div>
                        </div>
                        <div style="font-size: 1.25rem; font-weight: 700; color: #10b981;">{{ "%.1f" | format(precision) }}%</div>
                    </div>
                    
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; color: #374151;">Recall</div>
                            <div style="color: #6b7280; font-size: 0.875rem;">True PASS detection rate</div>
                        </div>
                        <div style="font-size: 1.25rem; font-weight: 700; color: #f59e0b;">{{ "%.1f" | format(recall) }}%</div>
                    </div>
                    
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; color: #374151;">Total Tests</div>
                            <div style="color: #6b7280; font-size: 0.875rem;">Dataset size</div>
                        </div>
                        <div style="font-size: 1.25rem; font-weight: 700; color: #6b7280;">{{ data.total_tests }}</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Disagreement Analysis -->
        {% if data.disagreements %}
        <div style="margin-top: 2rem;">
            <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: #374151;">Disagreement Datasets</h3>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                    <thead>
                        <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                            <th style="padding: 0.75rem 1rem; text-align: left; font-weight: 600; color: #374151;">Dataset</th>
                            <th style="padding: 0.75rem 1rem; text-align: left; font-weight: 600; color: #374151;">Expected</th>
                            <th style="padding: 0.75rem 1rem; text-align: left; font-weight: 600; color: #374151;">Actual</th>
                            <th style="padding: 0.75rem 1rem; text-align: left; font-weight: 600; color: #374151;">Reason</th>
                            <th style="padding: 0.75rem 1rem; text-align: center; font-weight: 600; color: #374151;">Links</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for disagreement in data.disagreements %}
                        <tr style="border-bottom: 1px solid #f1f5f9;">
                            <td style="padding: 0.75rem 1rem; font-family: 'Courier New', monospace; font-size: 0.875rem; font-weight: 600;">{{ disagreement.dataset }}</td>
                            <td style="padding: 0.75rem 1rem;">
                                <span style="padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600; 
                                    {% if disagreement.expected == 'PASS' %}background: #d1fae5; color: #065f46;{% else %}background: #fef2f2; color: #dc2626;{% endif %}">
                                    {{ disagreement.expected }}
                                </span>
                            </td>
                            <td style="padding: 0.75rem 1rem;">
                                <span style="padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600; 
                                    {% if disagreement.actual == 'PASS' %}background: #d1fae5; color: #065f46;{% else %}background: #fef2f2; color: #dc2626;{% endif %}">
                                    {{ disagreement.actual }}
                                </span>
                            </td>
                            <td style="padding: 0.75rem 1rem; color: #6b7280;">{{ disagreement.reason }}</td>
                            <td style="padding: 0.75rem 1rem; text-align: center;">
                                <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
                                    <a href="/output/{{ industry }}/{{ disagreement.dataset }}" 
                                       style="background: #3b82f6; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; text-decoration: none; font-size: 0.75rem; font-weight: 600;">
                                        📁 Output
                                    </a>
                                    <a href="/debug/compile?dataset={{ disagreement.dataset }}" 
                                       style="background: #7c3aed; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; text-decoration: none; font-size: 0.75rem; font-weight: 600;">
                                        🔧 Debug
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>
    {% endfor %}
    
    <!-- Download Section -->
    <div class="card" style="background: #f0fdf4; border: 1px solid #bbf7d0; margin-bottom: 2rem;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
            <h2 style="font-size: 1.5rem; font-weight: 600; color: #166534;">Golden Truth Pack v0.6</h2>
            <a href="/dist/golden_v0.6.zip" 
               style="background: #166534; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem;">
                📦 Download Pack
            </a>
        </div>
        <p style="color: #374151; margin-bottom: 1rem;">
            Validated dataset collection with expected outcomes for external benchmarking and algorithm validation.
        </p>
        <div style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
            <div style="background: white; padding: 1rem; border-radius: 0.5rem; border: 1px solid #d1fae5;">
                <div style="font-size: 1.25rem; font-weight: 700; color: #166534;">19</div>
                <div style="font-size: 0.875rem; color: #6b7280;">Total Datasets</div>
            </div>
            <div style="background: white; padding: 1rem; border-radius: 0.5rem; border: 1px solid #d1fae5;">
                <div style="font-size: 1.25rem; font-weight: 700; color: #166534;">6</div>
                <div style="font-size: 0.875rem; color: #6b7280;">Industries</div>
            </div>
            <div style="background: white; padding: 1rem; border-radius: 0.5rem; border: 1px solid #d1fae5;">
                <div style="font-size: 1.25rem; font-weight: 700; color: #166534;">SHA256</div>
                <div style="font-size: 0.875rem; color: #6b7280;">Verified Integrity</div>
            </div>
        </div>
    </div>

    <!-- Campaign Summary -->
    <div class="card" style="background: #f0f9ff; border: 1px solid #bfdbfe;">
        <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem; color: #1e40af;">Campaign Summary</h2>
        <div style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
            {% set total_disagreements = campaign_data.values() | sum(attribute='disagreements') | length %}
            {% set best_industry = campaign_data.items() | list | sort(attribute='1.confusion_matrix.true_positive', reverse=true) | first %}
            
            <div style="background: white; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb;">
                <div style="font-weight: 600; margin-bottom: 0.5rem;">Best Performing</div>
                <div style="font-size: 1.25rem; font-weight: 700; color: #10b981; text-transform: capitalize;">{{ best_industry[0] }}</div>
                <div style="color: #6b7280; font-size: 0.875rem;">{{ "%.1f" | format(((best_industry[1].confusion_matrix.true_positive + best_industry[1].confusion_matrix.true_negative) / best_industry[1].total_tests * 100)) }}% accuracy</div>
            </div>
            
            <div style="background: white; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb;">
                <div style="font-weight: 600; margin-bottom: 0.5rem;">Total Disagreements</div>
                <div style="font-size: 1.25rem; font-weight: 700; color: #dc2626;">{{ total_disagreements }}</div>
                <div style="color: #6b7280; font-size: 0.875rem;">Across all industries</div>
            </div>
            
            <div style="background: white; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb;">
                <div style="font-weight: 600; margin-bottom: 0.5rem;">Coverage</div>
                <div style="font-size: 1.25rem; font-weight: 700; color: #3b82f6;">{{ campaign_data | length }}/6</div>
                <div style="color: #6b7280; font-size: 0.875rem;">Industries tested</div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleStrictMode() {
    const strictModeCheckbox = document.getElementById('strictMode');
    const strictModeInfo = document.getElementById('strictModeInfo');
    const isChecked = strictModeCheckbox.checked;
    
    // Show/hide strict mode info
    strictModeInfo.style.display = isChecked ? 'block' : 'none';
    
    // Update URL with strict mode parameter
    const url = new URL(window.location);
    if (isChecked) {
        url.searchParams.set('strict', 'true');
    } else {
        url.searchParams.delete('strict');
    }
    
    // Reload page with new parameters
    window.location.href = url.toString();
}

// Initialize strict mode info visibility on page load
document.addEventListener('DOMContentLoaded', function() {
    const strictModeCheckbox = document.getElementById('strictMode');
    const strictModeInfo = document.getElementById('strictModeInfo');
    
    if (strictModeCheckbox.checked) {
        strictModeInfo.style.display = 'block';
    }
    
    // Add pulse animation to strict fail badges
    const strictFailBadges = document.querySelectorAll('[style*="STRICT FAIL"]');
    strictFailBadges.forEach(badge => {
        badge.style.animation = 'pulse 2s infinite';
    });
});

// Add CSS for pulse animation
const style = document.createElement('style');
style.textContent = `
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    .strict-mode-warning {
        background: linear-gradient(45deg, #dc2626, #991b1b);
        animation: pulse 2s infinite;
    }
`;
document.head.appendChild(style);
</script>

{% endblock %}