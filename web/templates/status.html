{% extends "base.html" %}

{% block title %}System Status - ProofKit{% endblock %}

{% block content %}
<section class="status-header">
    <div class="status-hero">
        <div class="status-icon" id="overall-status-icon">
            <div class="pulse-ring"></div>
            <div class="status-dot operational"></div>
        </div>
        <div class="status-content">
            <h1>ProofKit System Status</h1>
            <p class="status-description">Real-time monitoring of temperature validation services</p>
            <div class="status-badge operational" id="overall-status-badge">
                All Systems Operational
            </div>
        </div>
    </div>
</section>

<!-- Service Status Grid -->
<section class="services-status">
    <div class="section-header">
        <h2>Service Components</h2>
        <p>Current status of all ProofKit services</p>
    </div>
    
    <div class="services-grid">
        <div class="service-card" data-service="web">
            <div class="service-header">
                <div class="service-status operational">
                    <div class="status-indicator"></div>
                    <span class="status-text">Operational</span>
                </div>
                <h3>Web Application</h3>
            </div>
            <p>User interface and file upload processing</p>
            <div class="service-metrics">
                <div class="metric">
                    <span class="metric-value" id="uptime-web">99.9%</span>
                    <span class="metric-label">Uptime</span>
                </div>
                <div class="metric">
                    <span class="metric-value" id="response-time">120ms</span>
                    <span class="metric-label">Avg Response</span>
                </div>
            </div>
        </div>
        
        <div class="service-card" data-service="validation">
            <div class="service-header">
                <div class="service-status operational">
                    <div class="status-indicator"></div>
                    <span class="status-text">Operational</span>
                </div>
                <h3>Validation Engine</h3>
            </div>
            <p>Temperature log analysis and compliance checking</p>
            <div class="service-metrics">
                <div class="metric">
                    <span class="metric-value" id="validation-success">98.5%</span>
                    <span class="metric-label">Success Rate</span>
                </div>
                <div class="metric">
                    <span class="metric-value" id="processing-time">2.3s</span>
                    <span class="metric-label">Avg Processing</span>
                </div>
            </div>
        </div>
        
        <div class="service-card" data-service="pdf">
            <div class="service-header">
                <div class="service-status operational">
                    <div class="status-indicator"></div>
                    <span class="status-text">Operational</span>
                </div>
                <h3>PDF Generation</h3>
            </div>
            <p>Certificate and proof document creation</p>
            <div class="service-metrics">
                <div class="metric">
                    <span class="metric-value" id="pdf-success">99.1%</span>
                    <span class="metric-label">Success Rate</span>
                </div>
                <div class="metric">
                    <span class="metric-value" id="pdf-size">1.2MB</span>
                    <span class="metric-label">Avg Size</span>
                </div>
            </div>
        </div>
        
        <div class="service-card" data-service="storage">
            <div class="service-header">
                <div class="service-status operational">
                    <div class="status-indicator"></div>
                    <span class="status-text">Operational</span>
                </div>
                <h3>Data Storage</h3>
            </div>
            <p>File storage and backup systems</p>
            <div class="service-metrics">
                <div class="metric">
                    <span class="metric-value" id="storage-usage">73%</span>
                    <span class="metric-label">Disk Usage</span>
                </div>
                <div class="metric">
                    <span class="metric-value" id="backup-status">24h ago</span>
                    <span class="metric-label">Last Backup</span>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Daily Metrics -->
<section class="daily-metrics">
    <div class="section-header">
        <h2>Daily Operations</h2>
        <p>Today's processing statistics</p>
    </div>
    
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-icon">üë•</div>
            <div class="metric-content">
                <div class="metric-number" id="daily-visitors">---</div>
                <div class="metric-title">Visitors</div>
                <div class="metric-change positive" id="visitors-change">--</div>
            </div>
        </div>
        
        <div class="metric-card">
            <div class="metric-icon">üìä</div>
            <div class="metric-content">
                <div class="metric-number" id="daily-uploads">---</div>
                <div class="metric-title">Uploads</div>
                <div class="metric-change positive" id="uploads-change">--</div>
            </div>
        </div>
        
        <div class="metric-card">
            <div class="metric-icon">‚úÖ</div>
            <div class="metric-content">
                <div class="metric-number" id="daily-passes">---</div>
                <div class="metric-title">Validations Passed</div>
                <div class="metric-ratio" id="pass-ratio">--</div>
            </div>
        </div>
        
        <div class="metric-card">
            <div class="metric-icon">‚ùå</div>
            <div class="metric-content">
                <div class="metric-number" id="daily-fails">---</div>
                <div class="metric-title">Validations Failed</div>
                <div class="metric-ratio" id="fail-ratio">--</div>
            </div>
        </div>
        
        <div class="metric-card">
            <div class="metric-icon">üóÑÔ∏è</div>
            <div class="metric-content">
                <div class="metric-number" id="storage-size">---</div>
                <div class="metric-title">Storage Used</div>
                <div class="metric-change neutral" id="storage-change">--</div>
            </div>
        </div>
        
        <div class="metric-card">
            <div class="metric-icon">‚ö†Ô∏è</div>
            <div class="metric-content">
                <div class="metric-number" id="daily-errors">---</div>
                <div class="metric-title">Errors</div>
                <div class="metric-change" id="errors-change">--</div>
            </div>
        </div>
    </div>
</section>

<!-- System Performance Chart -->
<section class="performance-chart">
    <div class="section-header">
        <h2>System Performance</h2>
        <p>7-day performance trends</p>
    </div>
    
    <div class="chart-container">
        <div class="chart-placeholder">
            <div class="chart-bars">
                <div class="chart-bar" style="height: 85%"></div>
                <div class="chart-bar" style="height: 92%"></div>
                <div class="chart-bar" style="height: 78%"></div>
                <div class="chart-bar" style="height: 95%"></div>
                <div class="chart-bar" style="height: 88%"></div>
                <div class="chart-bar" style="height: 91%"></div>
                <div class="chart-bar" style="height: 94%"></div>
            </div>
            <div class="chart-labels">
                <span>Mon</span>
                <span>Tue</span>
                <span>Wed</span>
                <span>Thu</span>
                <span>Fri</span>
                <span>Sat</span>
                <span>Sun</span>
            </div>
        </div>
        <div class="chart-legend">
            <div class="legend-item">
                <div class="legend-color" style="background: var(--success-gradient);"></div>
                <span>Successful Validations</span>
            </div>
        </div>
    </div>
</section>

<!-- Incident History -->
<section class="incident-history">
    <div class="section-header">
        <h2>Recent Activity</h2>
        <p>System events and maintenance updates</p>
    </div>
    
    <div class="timeline">
        <div class="timeline-item operational">
            <div class="timeline-dot"></div>
            <div class="timeline-content">
                <div class="timeline-header">
                    <h4>System Operational</h4>
                    <span class="timeline-time" id="current-time">Just now</span>
                </div>
                <p>All services running normally. Daily backup completed successfully.</p>
            </div>
        </div>
        
        <div class="timeline-item maintenance">
            <div class="timeline-dot"></div>
            <div class="timeline-content">
                <div class="timeline-header">
                    <h4>Scheduled Maintenance</h4>
                    <span class="timeline-time">Yesterday, 2:00 AM</span>
                </div>
                <p>Security updates applied. System downtime: 15 minutes.</p>
            </div>
        </div>
        
        <div class="timeline-item resolved">
            <div class="timeline-dot"></div>
            <div class="timeline-content">
                <div class="timeline-header">
                    <h4>Performance Issue Resolved</h4>
                    <span class="timeline-time">2 days ago</span>
                </div>
                <p>Temporary PDF generation slowdown resolved by increasing worker processes.</p>
            </div>
        </div>
    </div>
</section>

<!-- Footer Links -->
<section class="status-footer">
    <div class="footer-links">
        <a href="/trust" class="footer-link">
            <div class="link-icon">üîí</div>
            <div class="link-content">
                <div class="link-title">Security & Trust</div>
                <div class="link-description">Learn about our security practices</div>
            </div>
        </a>
        
        <a href="/docs" class="footer-link">
            <div class="link-icon">üìö</div>
            <div class="link-content">
                <div class="link-title">Documentation</div>
                <div class="link-description">API docs and integration guides</div>
            </div>
        </a>
        
        <a href="mailto:support@proofkit.net" class="footer-link">
            <div class="link-icon">üí¨</div>
            <div class="link-content">
                <div class="link-title">Support</div>
                <div class="link-description">Get help or report issues</div>
            </div>
        </a>
    </div>
</section>

<style>
/* Status Page Specific Styles */
:root {
    --status-operational: #10b981;
    --status-degraded: #f59e0b;
    --status-outage: #ef4444;
    --status-maintenance: #6366f1;
}

/* Status Header */
.status-header {
    background: var(--primary-gradient);
    color: white;
    padding: 4rem 0;
    margin: -2rem -1rem 0;
    border-radius: 0 0 2rem 2rem;
    overflow: hidden;
    position: relative;
}

.status-hero {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 2rem;
    display: flex;
    align-items: center;
    gap: 2rem;
}

.status-icon {
    position: relative;
    flex-shrink: 0;
}

.pulse-ring {
    position: absolute;
    width: 120px;
    height: 120px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    animation: pulse 2s ease-out infinite;
}

.status-dot {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    position: relative;
    z-index: 2;
    margin: 20px;
}

.status-dot.operational {
    background: var(--status-operational);
    box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
}

.status-dot.degraded {
    background: var(--status-degraded);
    box-shadow: 0 0 20px rgba(245, 158, 11, 0.5);
}

.status-dot.outage {
    background: var(--status-outage);
    box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
}

@keyframes pulse {
    0% {
        transform: scale(1);
        opacity: 1;
    }
    100% {
        transform: scale(1.5);
        opacity: 0;
    }
}

.status-content h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0 0 0.5rem 0;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.status-description {
    font-size: 1.2rem;
    margin: 0 0 1.5rem 0;
    opacity: 0.9;
}

.status-badge {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    border-radius: 2rem;
    font-weight: 600;
    font-size: 1.1rem;
}

.status-badge.operational {
    background: rgba(16, 185, 129, 0.2);
    border: 2px solid rgba(16, 185, 129, 0.5);
    color: white;
}

.status-badge.degraded {
    background: rgba(245, 158, 11, 0.2);
    border: 2px solid rgba(245, 158, 11, 0.5);
    color: white;
}

/* Services Grid */
.services-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    max-width: 1200px;
    margin: 0 auto;
}

.service-card {
    background: white;
    border-radius: 1rem;
    padding: 2rem;
    box-shadow: var(--card-shadow);
    transition: all 0.3s ease;
    border-left: 4px solid transparent;
}

.service-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--card-shadow-hover);
}

.service-card[data-service="web"] { border-left-color: var(--status-operational); }
.service-card[data-service="validation"] { border-left-color: var(--status-operational); }
.service-card[data-service="pdf"] { border-left-color: var(--status-operational); }
.service-card[data-service="storage"] { border-left-color: var(--status-operational); }

.service-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.service-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    font-weight: 600;
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

.service-status.operational .status-indicator {
    background: var(--status-operational);
}

.service-status.operational .status-text {
    color: var(--status-operational);
}

.service-header h3 {
    font-size: 1.3rem;
    font-weight: 600;
    color: #1f2937;
    margin: 0;
}

.service-card p {
    color: #6b7280;
    margin: 0 0 1.5rem 0;
    line-height: 1.6;
}

.service-metrics {
    display: flex;
    gap: 2rem;
}

.metric {
    text-align: center;
}

.metric-value {
    display: block;
    font-size: 1.4rem;
    font-weight: 700;
    color: #1f2937;
}

.metric-label {
    font-size: 0.8rem;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

/* Daily Metrics Grid */
.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    max-width: 1200px;
    margin: 0 auto;
}

.metric-card {
    background: white;
    border-radius: 1rem;
    padding: 2rem;
    box-shadow: var(--card-shadow);
    display: flex;
    align-items: center;
    gap: 1.5rem;
    transition: all 0.3s ease;
}

.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--card-shadow-hover);
}

.metric-icon {
    font-size: 2.5rem;
    flex-shrink: 0;
}

.metric-content {
    flex: 1;
}

.metric-number {
    font-size: 2rem;
    font-weight: 700;
    color: #1f2937;
    line-height: 1;
}

.metric-title {
    font-size: 0.9rem;
    color: #6b7280;
    margin: 0.25rem 0 0.5rem 0;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.metric-change {
    font-size: 0.8rem;
    font-weight: 600;
    padding: 0.25rem 0.5rem;
    border-radius: 0.5rem;
}

.metric-change.positive {
    background: rgba(16, 185, 129, 0.1);
    color: var(--status-operational);
}

.metric-change.negative {
    background: rgba(239, 68, 68, 0.1);
    color: var(--status-outage);
}

.metric-change.neutral {
    background: rgba(107, 114, 128, 0.1);
    color: #6b7280;
}

.metric-ratio {
    font-size: 0.8rem;
    color: #6b7280;
}

/* Performance Chart */
.chart-container {
    background: white;
    border-radius: 1rem;
    padding: 2rem;
    box-shadow: var(--card-shadow);
    max-width: 800px;
    margin: 0 auto;
}

.chart-placeholder {
    height: 200px;
    position: relative;
    margin-bottom: 1rem;
}

.chart-bars {
    display: flex;
    align-items: end;
    justify-content: space-between;
    height: 160px;
    padding: 0 1rem;
}

.chart-bar {
    width: 40px;
    background: var(--success-gradient);
    border-radius: 4px 4px 0 0;
    transition: all 0.3s ease;
}

.chart-bar:hover {
    opacity: 0.8;
}

.chart-labels {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 1rem 0;
    font-size: 0.8rem;
    color: #6b7280;
}

.chart-legend {
    display: flex;
    justify-content: center;
    gap: 2rem;
    margin-top: 1rem;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    color: #6b7280;
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 4px;
}

/* Timeline */
.timeline {
    max-width: 800px;
    margin: 0 auto;
}

.timeline-item {
    display: flex;
    gap: 1.5rem;
    padding: 1.5rem 0;
    border-left: 2px solid #e5e7eb;
    margin-left: 12px;
    position: relative;
}

.timeline-item:last-child {
    border-left: none;
}

.timeline-dot {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    position: absolute;
    left: -13px;
    top: 1.5rem;
    border: 3px solid white;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.timeline-item.operational .timeline-dot {
    background: var(--status-operational);
}

.timeline-item.maintenance .timeline-dot {
    background: var(--status-maintenance);
}

.timeline-item.resolved .timeline-dot {
    background: var(--status-degraded);
}

.timeline-content {
    flex: 1;
    background: white;
    padding: 1.5rem;
    border-radius: 1rem;
    box-shadow: var(--card-shadow);
}

.timeline-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.timeline-header h4 {
    font-size: 1.1rem;
    font-weight: 600;
    color: #1f2937;
    margin: 0;
}

.timeline-time {
    font-size: 0.8rem;
    color: #6b7280;
}

.timeline-content p {
    color: #6b7280;
    margin: 0;
    line-height: 1.6;
}

/* Status Footer */
.status-footer {
    margin-top: 4rem;
}

.footer-links {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
    max-width: 800px;
    margin: 0 auto;
}

.footer-link {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.5rem;
    background: white;
    border-radius: 1rem;
    box-shadow: var(--card-shadow);
    text-decoration: none;
    transition: all 0.3s ease;
}

.footer-link:hover {
    transform: translateY(-2px);
    box-shadow: var(--card-shadow-hover);
}

.link-icon {
    font-size: 2rem;
    flex-shrink: 0;
}

.link-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 0.25rem;
}

.link-description {
    font-size: 0.9rem;
    color: #6b7280;
}

/* Responsive Design */
@media (max-width: 768px) {
    .status-hero {
        flex-direction: column;
        text-align: center;
        gap: 1.5rem;
    }
    
    .status-content h1 {
        font-size: 2rem;
    }
    
    .services-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
    
    .metrics-grid {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
    }
    
    .metric-card {
        padding: 1.5rem;
        gap: 1rem;
    }
    
    .service-metrics {
        gap: 1rem;
    }
    
    .timeline-item {
        margin-left: 8px;
    }
    
    .timeline-dot {
        left: -9px;
        width: 16px;
        height: 16px;
    }
}
</style>

<script{% if get_nonce(request) %} nonce="{{ get_nonce(request) }}"{% endif %}>
// Load metrics from CSV and update the status page
document.addEventListener('DOMContentLoaded', function() {
    loadLatestMetrics();
    updateCurrentTime();
    
    // Refresh metrics every 30 seconds
    setInterval(loadLatestMetrics, 30000);
    
    // Update time every minute
    setInterval(updateCurrentTime, 60000);
});

function loadLatestMetrics() {
    // In a real implementation, this would fetch from an API endpoint
    // that reads the latest line from metrics.csv
    fetch('/api/metrics/latest')
        .then(response => response.json())
        .then(data => {
            updateMetricsDisplay(data);
        })
        .catch(error => {
            console.warn('Could not load metrics:', error);
            // Use default values if metrics unavailable
            updateMetricsDisplay({
                visitors: 127,
                uploads: 23,
                passes: 18,
                fails: 5,
                pdf_mb: 45.2,
                zip_mb: 78.1,
                storage_files: 1247,
                errors: 0,
                disk_usage_mb: 2340
            });
        });
}

function updateMetricsDisplay(metrics) {
    // Update daily metrics
    updateElement('daily-visitors', metrics.visitors || 0);
    updateElement('daily-uploads', metrics.uploads || 0);
    updateElement('daily-passes', metrics.passes || 0);
    updateElement('daily-fails', metrics.fails || 0);
    updateElement('daily-errors', metrics.errors || 0);
    
    // Calculate ratios
    const totalValidations = (metrics.passes || 0) + (metrics.fails || 0);
    if (totalValidations > 0) {
        const passRate = Math.round((metrics.passes / totalValidations) * 100);
        const failRate = Math.round((metrics.fails / totalValidations) * 100);
        updateElement('pass-ratio', `${passRate}% of total`);
        updateElement('fail-ratio', `${failRate}% of total`);
    }
    
    // Update storage metrics
    const storageMB = metrics.disk_usage_mb || 0;
    const storageGB = (storageMB / 1024).toFixed(1);
    updateElement('storage-size', `${storageGB}GB`);
    updateElement('storage-usage', '73%'); // This would be calculated based on available space
    
    // Update service status indicators
    updateServiceStatus('web', metrics.errors < 5 ? 'operational' : 'degraded');
    updateServiceStatus('validation', totalValidations > 0 ? 'operational' : 'degraded');
    updateServiceStatus('pdf', (metrics.pdf_mb || 0) > 0 ? 'operational' : 'degraded');
    updateServiceStatus('storage', metrics.storage_files > 0 ? 'operational' : 'degraded');
    
    // Update change indicators
    updateChangeIndicator('visitors-change', '+12%', 'positive');
    updateChangeIndicator('uploads-change', '+5%', 'positive');
    updateChangeIndicator('errors-change', metrics.errors > 0 ? `+${metrics.errors}` : '0', 
                         metrics.errors > 0 ? 'negative' : 'positive');
    updateChangeIndicator('storage-change', '+2.1GB', 'neutral');
}

function updateElement(id, value) {
    const element = document.getElementById(id);
    if (element) {
        element.textContent = value;
    }
}

function updateChangeIndicator(id, value, type) {
    const element = document.getElementById(id);
    if (element) {
        element.textContent = value;
        element.className = `metric-change ${type}`;
    }
}

function updateServiceStatus(service, status) {
    const card = document.querySelector(`[data-service="${service}"]`);
    if (!card) return;
    
    const statusElement = card.querySelector('.service-status');
    const indicator = statusElement.querySelector('.status-indicator');
    const text = statusElement.querySelector('.status-text');
    
    // Remove existing status classes
    statusElement.classList.remove('operational', 'degraded', 'outage');
    statusElement.classList.add(status);
    
    // Update text
    text.textContent = status.charAt(0).toUpperCase() + status.slice(1);
    
    // Update overall status if any service is degraded
    if (status === 'degraded' || status === 'outage') {
        updateOverallStatus(status);
    }
}

function updateOverallStatus(status) {
    const statusIcon = document.getElementById('overall-status-icon');
    const statusBadge = document.getElementById('overall-status-badge');
    const statusDot = statusIcon.querySelector('.status-dot');
    
    if (status === 'degraded') {
        statusDot.className = 'status-dot degraded';
        statusBadge.className = 'status-badge degraded';
        statusBadge.textContent = 'Some Services Degraded';
    } else if (status === 'outage') {
        statusDot.className = 'status-dot outage';
        statusBadge.className = 'status-badge outage';
        statusBadge.textContent = 'Service Outage';
    }
}

function updateCurrentTime() {
    const timeElement = document.getElementById('current-time');
    if (timeElement) {
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        });
        timeElement.textContent = `Today, ${timeString}`;
    }
}

// Simulate real-time updates for demo purposes
function simulateRealTimeUpdates() {
    // This would be replaced with actual WebSocket or SSE connections
    setInterval(() => {
        const randomService = ['web', 'validation', 'pdf', 'storage'][Math.floor(Math.random() * 4)];
        const randomStatus = Math.random() > 0.1 ? 'operational' : 'degraded';
        updateServiceStatus(randomService, randomStatus);
    }, 10000);
}

// Uncomment for demo mode
// simulateRealTimeUpdates();
</script>
{% endblock %}