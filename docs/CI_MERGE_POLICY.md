# CI Merge Policy - Coverage Increment Strategy

## Overview

This document outlines the temporary coverage increment policy implemented during the CS-3 sprint to enable gradual coverage improvements while maintaining CI flow stability.

## Temporary `coverage-increment` Label

### Purpose
The `coverage-increment` label is a **temporary mechanism** designed to:
- Allow PRs with coverage below target thresholds to merge during the transition period
- Enable incremental coverage improvements without blocking development flow
- Maintain strict coverage enforcement on the main branch
- Facilitate the gradual path to our 92% total coverage target

### Implementation Details

#### GitHub Actions Configuration
```yaml
- name: Check coverage gates
  id: coverage-check
  continue-on-error: ${{ contains(github.event.pull_request.labels.*.name, 'coverage-increment') && github.event_name == 'pull_request' }}
  run: |
    python scripts/coverage_gate.py
```

This configuration ensures that:
- Coverage gate failures on PRs with the `coverage-increment` label will **not block** the merge
- Coverage gates remain **strict** on direct pushes to main branch
- The label only affects PR merge policies, not the underlying coverage requirements

## Usage Guidelines

### When to Use the `coverage-increment` Label

‚úÖ **Valid Usage:**
```
1. PRs that improve coverage but don't reach full targets yet
   Example: decide.py coverage increased from 79.2% to 85.4%

2. PRs that maintain existing coverage while adding new features
   Example: Adding new functionality with adequate test coverage

3. PRs that focus on non-coverage improvements (documentation, refactoring)
   Example: Code cleanup that doesn't change test coverage patterns

4. PRs that fix bugs without reducing overall coverage
   Example: Bug fixes with proper regression test coverage
```

### When NOT to Use the `coverage-increment` Label

‚ùå **Invalid Usage:**
```
1. PRs that significantly reduce existing coverage
   Example: Removing tests or adding large blocks of untested code

2. PRs that ignore coverage requirements entirely
   Example: Adding complex logic with no test coverage at all

3. PRs for critical security or compliance features
   Example: Changes to decision logic, validation, or certificate generation

4. PRs that would prevent reaching the 92% target
   Example: Adding substantial untested code that makes targets impossible
```

### Application Process

1. **Developer Assessment:**
   - Review coverage report generated by CI
   - Confirm that the PR makes progress toward coverage goals
   - Ensure the change doesn't significantly harm coverage trajectory

2. **Label Application:**
   - Add the `coverage-increment` label to the PR
   - Include justification in PR description
   - Reference specific coverage improvements or maintenance

3. **Review Process:**
   - Reviewer verifies appropriate label usage
   - Reviewer confirms coverage trajectory is positive or neutral
   - Approval requires both code quality and coverage justification

## Current Coverage Status (as of 2025-08-05)

### Target: 92% Total Coverage

| Component | Current | Target | Status | Gap |
|-----------|---------|--------|---------|-----|
| **Total Coverage** | 82.2% | 92.0% | ‚ùå | -9.8% |
| **core/decide.py** | 79.2% | 92.0% | ‚ùå | -12.8% |
| **cleanup.py** | 87.9% | 90.0% | ‚ùå | -2.1% |
| **logging.py** | 100.0% | 90.0% | ‚úÖ | +10.0% |

### Progress Tracking
- **Files above target:** 13/16 (81.3%)
- **Critical gaps:** 3 components below thresholds
- **Estimated effort:** ~156 additional test assertions needed

## Branch-Specific Behavior

### Main Branch (Strict Enforcement)
```bash
# On main branch pushes - coverage gates ALWAYS enforce strictly
$ python scripts/coverage_gate.py
üîí Main branch detected - strict enforcement enabled
   Coverage gates cannot be bypassed on main branch
```

- **No label bypass:** The `coverage-increment` label has no effect on main branch
- **Strict thresholds:** All coverage requirements must be met
- **Immediate failure:** Any threshold violation blocks the push

### Feature Branches (Flexible Enforcement)
```bash
# On PR branches - coverage gates respect the label
$ python scripts/coverage_gate.py
üí° Non-main branch - coverage gates may be relaxed with 'coverage-increment' label
```

- **Label-based bypass:** PRs with `coverage-increment` label can merge despite coverage failures
- **CI continues:** `continue-on-error: true` prevents CI blocking
- **Visibility maintained:** Coverage reports still generated and visible

## Removal Timeline

### Phase 1: Current State (CS-3 Sprint)
- `coverage-increment` label active and functional
- Gradual coverage improvements through individual PRs
- Focus on critical gaps: decide.py, cleanup.py

### Phase 2: Approaching Target (Next Sprint)
- Coverage reaches 90%+ total
- Label usage becomes more restrictive
- Focus shifts to edge cases and final gaps

### Phase 3: Target Achievement (Target: End of Q3 2025)
- 92% total coverage achieved and stable
- `coverage-increment` label **deprecated and removed**
- Strict enforcement becomes permanent across all branches

### Removal Checklist
```
‚ñ° Total coverage stable at ‚â•92% for 2+ weeks
‚ñ° All critical components above individual thresholds
‚ñ° No active PRs relying on coverage-increment label
‚ñ° CI configuration updated to remove continue-on-error
‚ñ° Documentation updated to reflect strict-only policy
‚ñ° Team notified of policy change
```

## Examples

### Example 1: Valid Usage - Incremental Improvement
```yaml
PR Title: "Improve decide.py test coverage from 79.2% to 85.4%"
Label: coverage-increment
Justification: "Added 23 test assertions covering edge cases in temperature
threshold detection. Still below 92% target but significant progress made."
```

### Example 2: Valid Usage - Feature Addition with Tests
```yaml
PR Title: "Add new industry metric: pharmaceutical validation"
Label: coverage-increment  
Justification: "New feature has 88% test coverage. Maintains overall project
coverage while adding valuable functionality."
```

### Example 3: Invalid Usage - Coverage Reduction
```yaml
PR Title: "Add complex decision logic without tests"
Label: coverage-increment ‚ùå INCORRECT USAGE
Issue: "Adds 150 lines of untested code, reducing total coverage to 78%.
This would set back progress significantly."
```

## Monitoring and Reporting

### Weekly Coverage Reports
- Coverage trend analysis
- Label usage statistics  
- Progress toward 92% target
- Identification of problem areas

### CI Integration
- Coverage reports on every PR
- Automatic trend detection
- Alert on significant coverage regressions
- Progress dashboards

## Team Responsibilities

### Developers
- Use `coverage-increment` label judiciously
- Prioritize coverage improvements in new code
- Include coverage justification in PR descriptions
- Focus on high-impact, low-effort coverage wins

### Reviewers
- Verify appropriate label usage
- Challenge coverage regressions
- Encourage coverage improvements
- Approve only when coverage trajectory is positive

### Technical Leads
- Monitor overall coverage trends
- Plan coverage improvement sprints
- Coordinate removal of temporary policy
- Ensure policy compliance

---

## Contact and Questions

For questions about this policy:
- **Primary Contact:** Technical Lead
- **Coverage Issues:** CI/CD Team  
- **Policy Updates:** Engineering Manager

**Last Updated:** 2025-08-05  
**Next Review:** 2025-08-19  
**Policy Effective:** During CS-3 Sprint (Temporary)